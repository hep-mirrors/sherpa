#!/bin/bash
TIME=`date`

rmr () {  
  for file in * ; do                                                          
    if [ -d $file ] ; then                                                       
      cd $file                                                                  
      rmr "$1" $2
      cd ..                                                             
    fi
  done  
  for i in $1 ; do    
    rm -f $2 $i                                                                         
  done
}                                                                               
RUNPATH=""
BINPATH=""
PDFPATH=""
RESULTS=""
ANALYSIS=""
LIBPATH="#"
SOPTIONS=""
BASENAME=""
BATCH="PBS"
BOPTIONS=""
NICE=""

print_help() {
  echo "run version 1.0" && echo && \
  echo "options: -p <path>      read configuration from path <path>" && \
  echo "         -b <binpath>   take executeable from path <binpath>" && \
  echo "         -s <pdfpath>   take pdfs from path <pdfpath>" && \
  echo "         -r <results>   write results to path <path>/<results>" && \
  echo "         -a <analysis>  write analysis output to path <path>/<analysis>" && \
  echo "         -e <events>    generate <events> events" && \
  echo "         -n <name>      set basic filename to <name>" && \
  echo "         -l <libpath>   define library path <libpath>" && \
  echo "         -o <option>    define commandline option <option>" && \
  echo "         -B <system>    select batch system <system>" && \
  echo "         -C <checkfile> write check file <checkfile>" && \
  echo "         -O <option>    define batch system option <option>" && \
  echo "         -H <host>      run job locally on <host>" && \
  echo "         -N <level>     set nice level for nohup" && \
  echo "         -S             submit job to batch system" && \
  echo "         -R             run job via nohup" && \
  echo "         -h             display this help and exit" && \
  echo
}

while getopts :p:b:s:r:a:e:n:l:o:B:C:O:H:N:SRh OPT
do
  case $OPT in
  p) RUNPATH=$OPTARG ;; 
  b) BINPATH=$OPTARG ;; 
  s) PDFPATH=$OPTARG ;; 
  r) RESULTS=$OPTARG ;; 
  a) ANALYSIS=$OPTARG ;; 
  e) EVENTS=$OPTARG ;; 
  n) BASENAME=$OPTARG ;; 
  l) LIBPATH=$OPTARG ;; 
  o) SOPTIONS=$SOPTIONS" "$OPTARG ;; 
  B) BATCH=$OPTARG ;; 
  C) SLOGFILE=$OPTARG ;; 
  O) BOPTIONS=$OPTARG ;; 
  H) RHOST=$OPTARG ;;
  N) NICE=$OPTARG ;;
  S) SUBMIT=TRUE ;;
  R) RUN=TRUE ;;
  h) print_help && exit 0 ;;
  \?)
    shift `expr $OPTIND - 1`
    echo -n "run: error: unrecognized option "
    if [ $OPTARG != "-" ]; then echo "'-$OPTARG'. try '--help'"
    else echo "'$1'. try '--help'"
    fi
    print_help && exit 1
  esac
done
if [ "$BINPATH" = "" ]; then BINPATH="." ; fi
if [ "$RUNPATH" = "" ]; then RUNPATH="./" ; fi
if [ "$RESULTS" = "" ]; then RESULTS="./" ; fi
if [ "$ANALYSIS" = "" ]; then ANALYSIS="./" ; fi
if [ "$BASENAME" = "" ]; then BASENAME="job" ; fi
$BINPATH/Sherpa --version > /dev/null 2>&1
if (( $? != 0 )) ; then
  BINPATH="."
  Sherpa --version > /dev/null 2>&1
  if (( $? != 0 )) ; then
    echo "run: executeable cannot be found in '$BINPATH' and \$PATH"
    echo "run: abort"
    exit 1
  fi
fi
if ! test -d $RUNPATH ; then
  echo "run: setup directory '$RUNPATH' does not exist"
  echo "run: abort"
  exit 2
fi
if ! test -d /$LIBPATH ; then 
  if ! test -d /$RUNPATH ; then LIBPATH=$PWD"/"$RUNPATH
  else LIBPATH=$RUNPATH
  fi
fi
if [ ! "$BATCH" = "PBS" ] && [ ! "$BATCH" = "SGE" ] ; then 
  echo "run: error: invalid batch system: '$BATCH'"
  echo "run: supported batch systems are: 'PBS' / 'SGE'"
  exit 3
fi

COUNTER=0
LOGPATH=$PWD
SETUPPATH=$LOGPATH"/"$BASENAME
while test -d $SETUPPATH"_"$COUNTER ; do
  (( ++COUNTER ))
done
SETUPPATH=$SETUPPATH"_"$COUNTER
LOGFILE="run.log"
FILE=$BASENAME"_"$COUNTER".sh"

mkdir $SETUPPATH
if test -d /$LIBPATH"/Process" ; then 
  ln -s $LIBPATH"/Process" $SETUPPATH"/Process"
fi
cp -ru $RUNPATH/* $SETUPPATH >> /dev/null 2>&1
echo "" > $FILE
if [ "$SUBMIT" = "TRUE" ] ; then 
  if [ "$BATCH" = "SGE" ] ; then
    echo "#$ -j y" >> $FILE
    echo "#$ -o $SETUPPATH" >> $FILE
    echo "#$ -N $FILE.$BATCH" >> $FILE
    if [ "$BOPTIONS" != "" ]; then
      echo "#$ "$BOPTIONS >> $FILE
    fi
  else
    echo "#"$BATCH" -oe" >> $FILE
    echo "#"$BATCH" -o $FILE.$BATCH" >> $FILE
    echo "#"$BATCH" -m ae" >> $FILE
    if [ "$BOPTIONS" != "" ]; then
      echo "#"$BATCH" "$BOPTIONS >> $FILE
    fi
  fi
  echo "" >> $FILE
  echo "RUNPATH=\"$SETUPPATH\"" >> $FILE
  echo "LOGFILE=\"$LOGFILE\"" >> $FILE
  echo "" >> $FILE
  echo "cd \$RUNPATH" >> $FILE
  echo "" >> $FILE
  echo "CNT=0; while test -f \$LOGFILE\"_\"\$CNT; do (( ++CNT )); done" >> $FILE
  echo "if test -f \$LOGFILE; then mv \$LOGFILE \$LOGFILE\"_\"\$CNT; fi" >> $FILE
  echo "" >> $FILE
  echo "echo \"\" > \$LOGFILE" >> $FILE
  echo "echo \"HOSTNAME    = \$HOSTNAME\" >> \$LOGFILE" >> $FILE
  echo "echo \"HOME        = \$HOME\" >> \$LOGFILE" >> $FILE
  echo "echo \"USER        = \$USER\" >> \$LOGFILE" >> $FILE
  echo "echo \"\" >> \$LOGFILE" >> $FILE
  if [ "$BATCH" = "SGE" ] ; then
    echo "echo \"JOB_ID      = \$JOB_ID\" >> \$LOGFILE" >> $FILE
    echo "echo \"JOB_NAME    = \$JOB_NAME\" >> \$LOGFILE" >> $FILE
    echo "echo \""$BATCH"_TASK_ID = \$"$BATCH"_TASK_ID\" >> \$LOGFILE" >> $FILE
    echo "echo \"QUEUE       = \$QUEUE\" >> \$LOGFILE" >> $FILE
    echo "echo \"TMPDIR      = \$TMPDIR\" >> \$LOGFILE" >> $FILE
  else
    echo "echo \""$BATCH"_JOBID     = \$"$BATCH"_JOBID\" >> \$LOGFILE" >> $FILE
    echo "echo \""$BATCH"_JOBNAME   = \$"$BATCH"_JOBNAME\" >> \$LOGFILE" >> $FILE
    echo "echo \""$BATCH"_O_QUEUE   = \$"$BATCH"_O_QUEUE\" >> \$LOGFILE" >> $FILE
    echo "echo \""$BATCH"_O_WORKDIR = \$"$BATCH"_O_WORKDIR\" >> \$LOGFILE" >> $FILE
  fi
  echo "echo \"\" >> \$LOGFILE" >> $FILE
  echo "" >> $FILE
  echo "echo \"Submitted on "$TIME"\" >> \$LOGFILE" >> $FILE
  echo "echo \"Started on   \`date\`\" >> \$LOGFILE" >> $FILE
  echo "" >> $FILE
  echo "echo \"\" >> \$LOGFILE" >> $FILE
  echo "" >> $FILE
else
  echo "#!/bin/bash" >> $FILE
  echo "" >> $FILE
  echo "RUNPATH=$SETUPPATH" >> $FILE
  echo "LOGFILE=\$SETUPPATH\"$LOGFILE\"" >> $FILE
  echo "" >> $FILE
  echo "cd \$RUNPATH" >> $FILE
  echo "" >> $FILE
fi
if [ "$PDFPATH" != "" ] ; then
  echo -e "export SHERPA_PDF_PATH=$PDFPATH\n" >> $FILE
fi
echo "export PATH=$BINPATH:\$PATH" >> $FILE
echo "" >> $FILE

echo -en "Sherpa " >> $FILE
if [ ! "$RESULTS" = "" ] ; then echo -en "RESULT_DIRECTORY=\"$RESULTS\" " >> $FILE ; fi
if [ ! "$ANALYSIS" = "" ] ; then echo -en "ANALYSIS_OUTPUT=\"$ANALYSIS\" " >> $FILE ; fi
if [ ! "$EVENTS" = "" ] ; then echo -en "EVENTS=$EVENTS " >> $FILE ; fi
if [ ! "$SOPTIONS" = "" ] ; then echo -en "$SOPTIONS " >> $FILE ; fi
echo -e ">> \$LOGFILE 2>&1\n\n" >> $FILE

chmod 777 $FILE
mv $FILE $SETUPPATH
if [ "$SUBMIT" = "TRUE" ] ; then
  cd $SETUPPATH
  qsub $FILE 
  cd $LOGPATH
elif [ "$RUN" = "TRUE" ] ; then
  sync
  RCOUNTER=0
  ssh -q $RHOST exit 
  while (( $? != 0 )) && (( $RCOUNTER < 5 )) ; do
    (( ++RCOUNTER ))
    if (( RCOUNTER > 1 )) ; then
      echo "run: host '"$RHOST"' not available."
    fi
    read -p "run: where shall your job '"$BASENAME"_"$COUNTER"' be run ? " RHOST
    ssh -q $RHOST exit 
  done
  ssh -q $RHOST exit 
  if (( $? ==0 )) ; then
    if [ "$NICE" = "" ] ; then
      ( ssh $RHOST "sync && ( nohup $SETUPPATH/$FILE > /dev/null ) &" ) &
    else 
      ( ssh $RHOST "sync && ( nohup nice -$NICE $SETUPPATH/$FILE > /dev/null ) &" ) &
    fi
  else 
    echo "run: error: cannot submit job '"$BASENAME"_"$COUNTER"'"
  fi 
fi
if ! [ "$SLOGFILE" = "" ] ; then
  echo "echo -e \"\n===> $SETUPPATH <===\"" >> $SLOGFILE
  echo "tail -1 $SETUPPATH/$LOGFILE" >> $SLOGFILE
  chmod 755 $SLOGFILE
fi

# mode:shell-script
# sh-indentation:2
