#!/bin/bash
RELEASE=#"TRUE"
LOGFILE="sherpa_install.log"

DIRS="ATOOLS-2.0 BEAM-1.0 PDF-1.0 MODEL-1.0 PHASIC++-1.0"
DIRS=$DIRS" EXTRA_XS-1.0 APACIC++-2.0 AMEGIC++-2.0 ADICIC++-0.0 AMISIC++-1.0"
DIRS=$DIRS" AHADIC++-0.0 ANALYSIS-1.0 SHERPA-1.0 COMPARE-1.0"

rmr () { 
  for file in `ls -a` ; do                                                          
    if [ $file != . ] && [ $file != .. ]; then
      if [ -d $file ] ; then                                                       
        cd $file  
        rmr "$1" $2
        cd ..                                                             
      fi
    fi
  done  
  for i in $1 ; do    
    rm -f $2 $i                                                                         
  done
}                                                                               

ECXXFLAGS=""
EFFLAGS=""
ECOPT=""
EMOPT=""
for I in $* ; do
  if [ "$I" = "-c" ]; then CONFIGURE=TRUE 
  elif [ "$I" = "-t" ]; then TOTAL=TRUE && CONFIGURE=TRUE
  elif [ "$I" = "-f" ]; then RELEASE=FALSE
  elif [ "$I" = "-r" ]; then RELEASE=TRUE
  elif [ "$I" = "-s" ]; then SCRIPT=TRUE
  elif [ "$I" = "-n" ]; then NOEXTRACT=TRUE
  elif [ "$I" = "--clean" ]; then CLEAN=TRUE
  elif [ "$I" = "--clean-run" ]; then RUNCLEAN=TRUE
  elif [ "$I" = "--no-abort" ]; then NOABORT=TRUE
  elif [ "$I" = "--copt" ]; then DCOPT=TRUE 
  elif [ "$I" = "--mopt" ]; then DMOPT=TRUE 
  elif [ "$I" = "--cxx" ]; then DCXXFLAGS=TRUE 
  elif [ "$I" = "--f" ]; then DFFLAGS=TRUE 
  elif [ "$I" = "--force-tar" ]; then FORCE=TRUE && NOEXTRACT=""
  elif [ "$I" = "--clean-up" ]; then CLEANUP=TRUE
  elif [ "$I" = "--rm-libs" ]; then RMLIBS=TRUE
  elif [ "$I" = "-h" ]; then echo && \
    echo "makeinstall version 1.0" && echo && \
    echo "options: -c             configure before compiling (enabled with '-t')" && \
    echo "         -t             rebuild 'Makefile.in's and 'configure' before compiling" && \
    echo "         -f             display the full information on the setup" && \
    echo "         -r             display minimal information but write a logfile instead" && \
    echo "         -s             create simple install scripts to be customized by the user" && \
    echo "         -n             do not extract tar files" && \
    echo "         --clean        execute 'make clean' in every module before compiling" && \
    echo "         --clean-run    execute './SHERPA-1.0/Run/makeclean' before compiling" && \
    echo "         --no-abort     ignore exit status of 'make'" && \
    echo "         --copt         define option for 'configure'" && \
    echo "         --mopt         define option for 'make' (default is '-j2')" && \
    echo "         --cxx          define cxx flag for 'make'" && \
    echo "         --f            define fortran flag for 'make'" && \
    echo "         --force-tar    force extraction of tar files" && \
    echo "         --clean-up     execute 'make clean' in every module" && \
    echo "         --rm-libs      remove shared libraries (does not remove '.lo' files)" && \
    echo "         -h             display this help and exit" && echo && \
    exit 0
  elif [ "$DCXXFLAGS" = "TRUE" ]; then DCXXFLAGS="" && ECXXFLAGS=$I" "$ECXXFLAGS
  elif [ "$DFFLAGS" = "TRUE" ]; then DFFLAGS="" && EFFLAGS=$I" "$EFFLAGS
  elif [ "$DCOPT" = "TRUE" ]; then DCOPT="" && ECOPT=$I" "$ECOPT
  elif [ "$DMOPT" = "TRUE" ]; then DMOPT="" && EMOPT=$I" "$EMOPT
  else echo "makeinstall: error: unrecognized option '$I'. try '-h'" && \
    exit 1 
  fi
done
if [ ! "$ECXXFLAGS" = "" ]; then ECXXFLAGS="CXXFLAGS="$ECXXFLAGS ; fi
if [ ! "$EFFLAGS" = "" ]; then EFFLAGS="FFLAGS="$EFFLAGS ; fi
if [ "$EMOPT" = "" ]; then EMOPT="-j2" ; fi

if [ "$SCRIPT" = "TRUE" ] ; then 
  echo "makeinstall: creating simple install scripts"
  read -t 60 -p "please input the desired name: " NAME
  if ! test -f $NAME ; then 
    echo -e "#!/bin/bash\n\nlibtoolize --force\naclocal\nautomake -a\nautoconf\n" > $NAME
    echo -e "./configure\nmake install" >> $NAME
    chmod 775 $NAME
  else
    echo "makeinstall: error: file '$NAME' already exists"
  fi
  NAME=$NAME"_all"
  if ! test -f $NAME ; then 
    echo -e "#!/bin/bash\n\nDIRS=\"$DIRS\"\n\nfor I in \$DIRS ; do\n\n  cd \$I\n" > $NAME
    echo -e "  libtoolize --force\n  aclocal\n  automake -a\n  autoconf\n" >> $NAME
    echo -e "  ./configure\n  make install\n\n  cd ../\n\ndone" >> $NAME
    chmod 775 $NAME
  else
    echo "makeinstall: error: file '$NAME' already exists"
  fi
  exit 0
fi
if [ "`gcc -dumpversion`" = "2.96" ] ; then 
  echo -e "\n\e[31m********************************************************\e[0m"
  echo -e "\e[31m*\e[0m\e[1m                     Severe Error                     \e[0m\e[31m*\e[0m"
  echo -e "\e[31m********************************************************\e[0m"
  echo -e "\e[31m*                                                      *\e[0m"
  echo -e "\e[31m*\e[0m\e[1m   The Sherpa package will not compile on gcc 2.96.   \e[0m\e[31m*\e[0m"
  echo -e "\e[31m*                                                      *\e[0m"
  echo -e "\e[31m*\e[0m gcc 2.96 causes different problems with STL headers. \e[31m*\e[0m"
  echo -e "\e[31m*\e[0m Please note that if you insist on using this version \e[31m*\e[0m"
  echo -e "\e[31m*\e[0m           we will not provide any support.           \e[31m*\e[0m"
  echo -e "\e[31m*                                                      \e[31m*\e[0m"
  echo -e "\e[31m*\e[31m              We recommend you to employ              \e[31m*\e[0m"
  echo -e "\e[31m*\e[31m        gcc 2.95 or any of the 3.x.x versions         \e[31m*\e[0m"
  echo -e "\e[31m*                                                      \e[31m*\e[0m"
  echo -e "\e[31m*\e[0m\e[1m              Aborting the installation               \e[0m\e[31m*\e[0m"
  echo -e "\e[31m*                                                      *\e[0m"
  echo -e "\e[31m********************************************************\e[0m\n"
  exit 1;
fi

if [ ! "$NOEXTRACT" = "TRUE" ] ; then
  ALL=
  INFORM=TRUE
  for I in $DIRS;
  do
    if test -s $I.tar.gz; then
      if `test ! -d $I` || `test "$FORCE" = "TRUE"` ; then 
        if [ "$INFORM" = "TRUE" ] ; then
	  INFORM=
	  CONFIGURE=TRUE
	  if [ "$RELEASE" = "TRUE" ] ; then
	    echo -e "\n\e[1m\e[31m******************************************************\e[0m"
	    echo -e "\e[1m\e[31m*\e[0m\e[1m           Extracting the SHERPA package            \e[31m*\e[0m"
	    echo -e "\e[1m\e[31m******************************************************\e[0m\n"
	  else
	    echo "**************************************"
	    echo "*   Extracting the SHERPA package    *"
	    echo "**************************************"
	  fi
        fi
        if [ ! "$RELEASE" = "TRUE" ] ; then
          echo "======================================"
          echo " extracting $I"
          echo "======================================"
          tar -xzvf $I.tar.gz
	else
	  echo -ne "extracting module $I ...\r"
          tar -xzf $I.tar.gz > /dev/null
          echo -e "\e[32m\t\t\t\t\t\t  done\e[0m"
        fi
        ALL=$ALL" "$I.tar.gz 
      else
        echo "makeinstall: warning: cannot extract $I.tar.gz. directory present"
      fi
    fi
  done
  rm -f $ALL
fi

if [ "$RELEASE" = "TRUE" ] ; then
  echo -e "\n\e[32m******************************************************\e[0m"
  echo -e "\e[32m*\e[0m\e[5m\e[1m           Installing the SHERPA package            \e[0m\e[32m*\e[0m"
  echo -e "\e[32m******************************************************\e[0m\n"
  echo -e "writing stdout and stderr to '$LOGFILE'\n"
  echo -e "Starting installation at '$HOSTNAME' (architecture $HOSTTYPE) on `date`\n" > $LOGFILE
  echo -e "PATH=$PATH\n\nLD_LIBRARY_PATH=$LD_LIBRARY_PATH\n\nCLHEPDIR=$CLHEPDIR\n" >> $LOGFILE
  echo -en "gcc --version -> " >> $LOGFILE && gcc --version >> $LOGFILE
else
  echo "**************************************"
  echo "*   Installing the SHERPA package    *"
  echo "**************************************"
fi
if [ "$RUNCLEAN" = "TRUE" ] ; then
  if cd SHERPA-1.0/Run ; then
    ./makeclean
    cd ../..
  fi
fi

if [ "$SED" = "" ] ; then export SED="sed" ; fi
if [ "$TOTAL" = "TRUE" ] && [ "$RELEASE" = "TRUE" ] ; then
  echo -ne "removing old setup files ...\r"
fi
for I in $DIRS;
do
  if test -d $I; then
    cd $I
      if [ "$RMLIBS" = "TRUE" ] ; then
        echo " removing libraries in $I"
        rmr "*.la *.so *.so.0 *.so.0.0.0"
      fi
      if [ "$CLEANUP" = "TRUE" ] ; then 
        echo " making clean in $I"
        make clean
      fi
      if [ "$TOTAL" = "TRUE" ] ; then
	if [ "$RELEASE" = "TRUE" ] ; then
          echo " removing setup files in $I" >> ../$LOGFILE 2>&1
	else
          echo " removing setup files in $I" 
	fi
        rmr "Makefile Makefile.in \
             aclocal.m4 config.guess config.log config.status config.sub configure \
             depcomp install-sh libtool ltconfig ltmain.sh missing mkinstalldirs"
        rmr "autom4te.cache" -r
      fi
    cd ..
  else 
    echo "makeinstall: warning: directory $I not found"
  fi
done
if [ "$TOTAL" = "TRUE" ] && [ "$RELEASE" = "TRUE" ] ; then
  echo -e "\e[32m\t\t\t\t\t\t  done\e[0m\n"
fi
if test "$RMLIBS" = "TRUE" || test "$CLEANUP" = "TRUE" ; then
  exit 0;
fi

for I in $DIRS;
do
  if test -d $I; then
    if [ ! "$RELEASE" = "TRUE" ] ; then
      echo "======================================"
      echo " making install in $I"
      echo "======================================"
    else
      echo -ne "installing module $I ...\r"
    fi
    cd $I 
    if test ! -f Makefile.in || test "$TOTAL" = "TRUE" ; then
      if [ "$RELEASE" = "TRUE" ] ; then
        libtoolize --force >> ../$LOGFILE 2>&1
        aclocal >> ../$LOGFILE 2>&1
        automake -a >> ../$LOGFILE 2>&1
        autoconf >> ../$LOGFILE 2>&1
      else
        libtoolize --force
        aclocal
        automake -a
        autoconf
      fi
    fi
    if test ! -f Makefile || test "$CONFIGURE" = "TRUE" ; then
      if [ "$RELEASE" = "TRUE" ] ; then
        ./configure $ECOPT >> ../$LOGFILE 2>&1
      else
        ./configure $ECOPT
      fi
    fi
    if `test "$CLEAN" = "TRUE"` ; then 
      if [ "$RELEASE" = "TRUE" ] ; then
        make clean >> ../$LOGFILE 2>&1
      else
        make clean
      fi
    fi
    CONTINUE="r"
    while test "$CONTINUE" = "r" ; do 
      CONTINUE=""
      if ! ( if [ "$RELEASE" = "TRUE" ] ; then
	       if [ "$ECXXFLAGS" = "" ] && [ "$EFFLAGS" = "" ] ; then make install $EMOPT >> ../$LOGFILE 2>&1 
               elif [ "$EFFLAGS" = "" ] ; then make install $EMOPT "$ECXXFLAGS" >> ../$LOGFILE 2>&1 
               elif [ "$ECXXFLAGS" = "" ] ; then make install $EMOPT "$EFFLAGS" >> ../$LOGFILE 2>&1 
               else make install $EMOPT "$ECXXFLAGS" "$EFFLAGS" >> ../$LOGFILE 2>&1 
               fi
             else 
               if [ "$ECXXFLAGS" = "" ] && [ "$EFFLAGS" = "" ] ; then make install $EMOPT 
               elif [ "$EFFLAGS" = "" ] ; then make install $EMOPT "$ECXXFLAGS" 
               elif [ "$ECXXFLAGS" = "" ] ; then make install $EMOPT "$EFFLAGS" 
               else make install $EMOPT "$ECXXFLAGS" "$EFFLAGS" 
               fi 
	     fi ) ; then
        if [ "$RELEASE" = "TRUE" ] ; then 
          echo -e "\e[31m\t\t\t\t\t\tfailed\e[0m" 
        else 
	  echo "makeinstall: error: \"make install\" in $I failed"
        fi
        if [ ! "$NOABORT" = "TRUE" ] ; then
          until test "$CONTINUE" = "y" || test "$CONTINUE" = "n" || test "$CONTINUE" = "r" ; do
    	    if ! read -t 300 -p "continue anyway (y/n/r/b/c/t) ? " CONTINUE ; then
	      echo ""
	      CONTINUE="n"
	    fi
	    if [ "$CONTINUE" = "n" ] ; then
	      if [ "$RELEASE" = "TRUE" ] ; then
                `echo clear`
	        echo -e "\nIt seems that you have problems setting up the package $I"
	        echo -e "If they persist please contact us under\n"
	        echo -e "  krauss@theory.phy.tu-dresden.de\n"
		echo -e "Please send us the complete installation logfile '$LOGFILE'\n"
	      fi
              exit 1
	    elif [ "$CONTINUE" = "b" ] ; then
              bash
	      CONTINUE="r"
	    elif [ "$CONTINUE" = "c" ] ; then
              ./configure
	      CONTINUE="r"
	    elif [ "$CONTINUE" = "t" ] ; then
	      libtoolize --force
	      aclocal
	      automake -a
	      autoconf
              ./configure
	      CONTINUE="r"
	    fi
	  done
        fi
      else
        if [ "$RELEASE" = "TRUE" ] ; then echo -e "\e[32m\t\t\t\t\t\t  done\e[0m" ; fi
      fi
    done
    cd ..
  else
    echo "makeinstall: warning: directory $I not found"
  fi
done;
sleep 1
if [ "$RELEASE" = "TRUE" ] ; then
  if test ! "$CONTINUE" = "n" ; then
    `echo clear`
    echo -e "\e[34m*******************************************************"
    echo -e "*\e[0m                                                     \e[34m*"
    echo -e "*\e[0m\e[1m   Initial setup of Sherpa successfully completed    \e[0m\e[34m*"
    echo -e "*\e[0m                                                     \e[34m*"
    echo -e "*\e[0m  Please check our web page for recent developments  \e[34m*"
    echo -e "*\e[0m                                                     \e[34m*"
    echo -e "*\e[0m    http://www.physik.tu-dresden.de/~krauss/hep/     \e[34m*"
    echo -e "*\e[0m                                                     \e[34m*"
    echo -e "*******************************************************\e[0m"
    echo -e "\nhave a nice day `whoami`\n"
  fi
fi

# mode:shell-script
# sh-indentation:2
